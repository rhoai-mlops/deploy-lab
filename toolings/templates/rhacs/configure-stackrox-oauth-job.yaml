---
apiVersion: batch/v1
kind: Job
metadata:
  name: configure-stackrox-oauth
  namespace: rhacs-operator
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      containers:
        - image: quay.io/rht-labs/stack-do500:3.0.8
          command:
            - /bin/bash
            - -c
            - |
              set -e
              {{- if .Values.stackrox.verbose }}
              set -x
              {{- end }}

              {{- if .Values.stackrox.oauth.enabled }}
              echo "Starting RHACS OAuth Configuration..."

              # Get Central route
              CENTRAL="$(oc -n rhacs-operator get routes/central -o jsonpath='{.spec.host}')"
              echo "Central endpoint: ${CENTRAL}"

              # Wait for Central to be fully available
              echo "Waiting for Central API to be ready..."
              MAX_RETRIES=30
              RETRY_COUNT=0
              until curl -sk -u admin:myPassw0rd https://${CENTRAL}/v1/ping >/dev/null 2>&1; do
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
                  echo "Central API is not ready after ${MAX_RETRIES} attempts"
                  exit 1
                fi
                echo "Waiting for Central API... (attempt ${RETRY_COUNT}/${MAX_RETRIES})"
                sleep 10
              done
              echo "Central API is ready"

              # Create Authentication Provider
              echo "Creating authentication provider: {{ .Values.stackrox.oauth.authProvider }}"
              curl -sk -u admin:myPassw0rd -XPOST -H 'Content-Type: application/json' \
                -d '{"name":"{{ .Values.stackrox.oauth.authProvider }}","type":"{{ .Values.stackrox.oauth.authProviderType }}","active":true,"uiEndpoint":"central","enabled":true}' \
                https://${CENTRAL}/v1/authProviders > /tmp/auth-provider.json

              # Check if provider creation succeeded or already exists
              if grep -q "already exists" /tmp/auth-provider.json 2>/dev/null; then
                echo "Authentication provider already exists"
              elif grep -q "id" /tmp/auth-provider.json 2>/dev/null; then
                echo "Authentication provider created successfully"
              else
                echo "Unexpected response when creating auth provider:"
                cat /tmp/auth-provider.json
              fi

              # Get Auth Provider ID
              echo "Retrieving authentication provider ID..."
              AUTH_PROVIDER_ID=$(curl -sk -u admin:myPassw0rd "https://${CENTRAL}/v1/authProviders?name={{ .Values.stackrox.oauth.authProvider }}" | python3 -c "import sys, json; print(json.load(sys.stdin)['authProviders'][0]['id'])")

              if [ -z "$AUTH_PROVIDER_ID" ] || [ "$AUTH_PROVIDER_ID" = "null" ]; then
                echo "Failed to get authentication provider ID"
                exit 1
              fi
              echo "Authentication provider ID: ${AUTH_PROVIDER_ID}"

              # Set Default Role for Auth Provider
              echo "Setting default role to {{ .Values.stackrox.oauth.minAccessRole }}..."
              curl -sk -u admin:myPassw0rd -XPOST -H 'Content-Type: application/json' \
                https://${CENTRAL}/v1/groupsbatch --data-binary @- <<DATA
              {
                "previous_groups": [],
                "required_groups": [
                  {
                    "props": {
                      "authProviderId": "${AUTH_PROVIDER_ID}"
                    },
                    "roleName": "{{ .Values.stackrox.oauth.minAccessRole }}"
                  }
                ]
              }
              DATA

              echo "Default role configured successfully"

              # Set kube:admin mapping to Admin role
              echo "Setting kube:admin mapping to Admin role..."
              curl -sk -u admin:myPassw0rd -XPOST -H 'Content-Type: application/json' \
                https://${CENTRAL}/v1/groupsbatch --data-binary @- <<DATA
              {
                "previous_groups": [],
                "required_groups": [
                  {
                    "props": {
                      "authProviderId": "${AUTH_PROVIDER_ID}",
                      "key": "name",
                      "value": "admin"
                    },
                    "roleName": "Admin"
                  }
                ]
              }
              DATA

              echo "kube:admin mapping configured successfully"
              echo "RHACS OAuth Configuration completed successfully"
              {{- else }}
              echo "OAuth configuration is disabled, skipping..."
              {{- end }}

              exit 0
          imagePullPolicy: Always
          name: configure-stackrox-oauth
      dnsPolicy: ClusterFirst
      restartPolicy: OnFailure
      serviceAccount: configure-stackrox
      serviceAccountName: configure-stackrox
      terminationGracePeriodSeconds: 10
